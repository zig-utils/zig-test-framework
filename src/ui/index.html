<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zig Test Framework - Live Results</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 2px solid #21262d;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #58a6ff;
        }

        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            margin-top: 10px;
        }

        .status.connected {
            background: #238636;
            color: #fff;
        }

        .status.disconnected {
            background: #da3633;
            color: #fff;
        }

        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat {
            background: #161b22;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #21262d;
            text-align: center;
        }

        .stat-value {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #8b949e;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 1px;
        }

        .stat.total .stat-value { color: #58a6ff; }
        .stat.passed .stat-value { color: #3fb950; }
        .stat.failed .stat-value { color: #f85149; }
        .stat.skipped .stat-value { color: #d29922; }

        .tests {
            background: #161b22;
            border-radius: 8px;
            border: 1px solid #21262d;
            overflow: hidden;
        }

        .suite {
            border-bottom: 1px solid #21262d;
        }

        .suite:last-child {
            border-bottom: none;
        }

        .suite-header {
            background: #1c2128;
            padding: 15px 20px;
            font-weight: 600;
            color: #58a6ff;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .suite-header:hover {
            background: #22272e;
        }

        .suite-tests {
            padding: 10px 0;
        }

        .test {
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid transparent;
            transition: all 0.2s;
        }

        .test:hover {
            background: #1c2128;
        }

        .test.running {
            border-left-color: #58a6ff;
            background: #1c2128;
        }

        .test.passed {
            border-left-color: #3fb950;
        }

        .test.failed {
            border-left-color: #f85149;
            background: #1c2128;
        }

        .test.skipped {
            border-left-color: #d29922;
            opacity: 0.6;
        }

        .test-name {
            flex: 1;
        }

        .test-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 10px;
        }

        .test-status.running {
            background: #1f6feb;
            color: #fff;
        }

        .test-status.passed {
            background: #238636;
            color: #fff;
        }

        .test-status.failed {
            background: #da3633;
            color: #fff;
        }

        .test-status.skipped {
            background: #9e6a03;
            color: #fff;
        }

        .test-time {
            color: #8b949e;
            font-size: 0.85em;
            margin-left: 10px;
        }

        .test-error {
            margin-top: 8px;
            padding: 10px;
            background: #2d1519;
            border: 1px solid #da3633;
            border-radius: 4px;
            color: #f85149;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #21262d;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1f6feb, #58a6ff);
            width: 0%;
            transition: width 0.3s ease;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #21262d;
            border-top-color: #58a6ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #8b949e;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>âš¡ Zig Test Framework</h1>
            <div class="status disconnected" id="connection-status">
                <span class="spinner"></span> Connecting...
            </div>
        </header>

        <div class="summary">
            <div class="stat total">
                <div class="stat-value" id="total-tests">0</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat passed">
                <div class="stat-value" id="passed-tests">0</div>
                <div class="stat-label">Passed</div>
            </div>
            <div class="stat failed">
                <div class="stat-value" id="failed-tests">0</div>
                <div class="stat-label">Failed</div>
            </div>
            <div class="stat skipped">
                <div class="stat-value" id="skipped-tests">0</div>
                <div class="stat-label">Skipped</div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>

        <div class="tests" id="tests">
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ“‹</div>
                <h2>Waiting for tests...</h2>
                <p>Test results will appear here when tests start running.</p>
            </div>
        </div>
    </div>

    <script>
        const state = {
            total: 0,
            passed: 0,
            failed: 0,
            skipped: 0,
            suites: new Map(),
            currentSuite: null
        };

        const elements = {
            connectionStatus: document.getElementById('connection-status'),
            totalTests: document.getElementById('total-tests'),
            passedTests: document.getElementById('passed-tests'),
            failedTests: document.getElementById('failed-tests'),
            skippedTests: document.getElementById('skipped-tests'),
            progress: document.getElementById('progress'),
            tests: document.getElementById('tests')
        };

        function connectSSE() {
            const eventSource = new EventSource('/events');

            eventSource.addEventListener('connected', () => {
                elements.connectionStatus.textContent = 'Connected';
                elements.connectionStatus.className = 'status connected';
            });

            eventSource.addEventListener('run_start', (e) => {
                const data = JSON.parse(e.data);
                state.total = data.total;
                updateStats();
                clearTests();
            });

            eventSource.addEventListener('suite_start', (e) => {
                const data = JSON.parse(e.data);
                state.currentSuite = data.name;
                addSuite(data.name);
            });

            eventSource.addEventListener('test_start', (e) => {
                const data = JSON.parse(e.data);
                addTest(state.currentSuite, data.name, 'running');
            });

            eventSource.addEventListener('test_end', (e) => {
                const data = JSON.parse(e.data);
                updateTest(state.currentSuite, data.name, data.status, data.execution_time_ns, data.error_message);

                if (data.status === 'passed') state.passed++;
                else if (data.status === 'failed') state.failed++;
                else if (data.status === 'skipped') state.skipped++;

                updateStats();
            });

            eventSource.addEventListener('run_end', (e) => {
                const data = JSON.parse(e.data);
                state.total = data.total;
                state.passed = data.passed;
                state.failed = data.failed;
                state.skipped = data.skipped;
                updateStats();
            });

            eventSource.onerror = () => {
                elements.connectionStatus.textContent = 'Disconnected';
                elements.connectionStatus.className = 'status disconnected';
                eventSource.close();

                setTimeout(connectSSE, 3000);
            };
        }

        function updateStats() {
            elements.totalTests.textContent = state.total;
            elements.passedTests.textContent = state.passed;
            elements.failedTests.textContent = state.failed;
            elements.skippedTests.textContent = state.skipped;

            const completed = state.passed + state.failed + state.skipped;
            const progress = state.total > 0 ? (completed / state.total) * 100 : 0;
            elements.progress.style.width = `${progress}%`;
        }

        function clearTests() {
            state.suites.clear();
            state.passed = 0;
            state.failed = 0;
            state.skipped = 0;
            elements.tests.innerHTML = '';
        }

        function addSuite(name) {
            const suiteEl = document.createElement('div');
            suiteEl.className = 'suite';
            suiteEl.innerHTML = `
                <div class="suite-header">${name}</div>
                <div class="suite-tests"></div>
            `;
            elements.tests.appendChild(suiteEl);
            state.suites.set(name, suiteEl);
        }

        function addTest(suiteName, testName, status) {
            const suite = state.suites.get(suiteName);
            if (!suite) return;

            const testsContainer = suite.querySelector('.suite-tests');
            const testEl = document.createElement('div');
            testEl.className = `test ${status}`;
            testEl.dataset.testName = testName;
            testEl.innerHTML = `
                <div class="test-name">${testName}</div>
                <span class="test-status ${status}">${status}</span>
            `;
            testsContainer.appendChild(testEl);
        }

        function updateTest(suiteName, testName, status, timeNs, errorMessage) {
            const suite = state.suites.get(suiteName);
            if (!suite) return;

            const testEl = suite.querySelector(`[data-test-name="${testName}"]`);
            if (!testEl) return;

            testEl.className = `test ${status}`;
            const statusEl = testEl.querySelector('.test-status');
            statusEl.className = `test-status ${status}`;
            statusEl.textContent = status;

            if (timeNs > 0) {
                const timeMs = (timeNs / 1000000).toFixed(2);
                const timeEl = document.createElement('span');
                timeEl.className = 'test-time';
                timeEl.textContent = `${timeMs}ms`;
                testEl.appendChild(timeEl);
            }

            if (errorMessage && errorMessage.length > 0) {
                const errorEl = document.createElement('div');
                errorEl.className = 'test-error';
                errorEl.textContent = errorMessage;
                testEl.appendChild(errorEl);
            }
        }

        connectSSE();
    </script>
</body>
</html>
